d3.select(this)
.transition()
.duration(200)
.attr("opacity", 1);
})
.transition()
.duration(800)
.delay((d, i) => i * 30)
.attr("y", d => y(d.length))
.attr("height", d => height - y(d.length));
// Add x axis
svg.append("g")
.attr("transform", `translate(0,${height})`)
.call(d3.axisBottom(x))
.style("font-size", "12px")
.selectAll("text")
.style("font-family", "system-ui, -apple-system, sans-serif");
svg.append("text")
.attr("x", width / 2)
.attr("y", height + 40)
.style("text-anchor", "middle")
.style("font-size", "14px")
.style("font-family", "system-ui, -apple-system, sans-serif")
.text("Poverty Rate (%)");
// Add y axis
svg.append("g")
.call(d3.axisLeft(y))
.style("font-size", "12px")
.selectAll("text")
.style("font-family", "system-ui, -apple-system, sans-serif");
svg.append("text")
.attr("transform", "rotate(-90)")
.attr("x", -height / 2)
.attr("y", -35)
.style("text-anchor", "middle")
.style("font-size", "14px")
.style("font-family", "system-ui, -apple-system, sans-serif")
.text("Count");
</script>
'))
#| echo: false
#| message: false
#| warning: false
#| title: "Poverty Rate Distribution"
library(htmltools)
library(jsonlite)
# Prepare data for D3
hist_data <- cu_data$Poverty.Rate[!is.na(cu_data$Poverty.Rate)]
HTML(paste0('
<div id="histogram" style="width: 100%; height: 100%;"></div>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
const data = ', toJSON(hist_data), ';
const margin = {top: 20, right: 30, bottom: 50, left: 50};
const width = document.getElementById("histogram").clientWidth - margin.left - margin.right;
const height = document.getElementById("histogram").clientHeight - margin.top - margin.bottom;
const svg = d3.select("#histogram")
.append("svg")
.attr("width", width + margin.left + margin.right)
.attr("height", height + margin.top + margin.bottom)
.append("g")
.attr("transform", `translate(${margin.left},${margin.top})`);
const x = d3.scaleLinear()
.domain([0, d3.max(data)])
.range([0, width]);
const histogram = d3.histogram()
.domain(x.domain())
.thresholds(x.ticks(15));
const bins = histogram(data);
const y = d3.scaleLinear()
.domain([0, d3.max(bins, d => d.length)])
.range([height, 0]);
// Add gradient
const gradient = svg.append("defs")
.append("linearGradient")
.attr("id", "bar-gradient")
.attr("x1", "0%")
.attr("y1", "0%")
.attr("x2", "0%")
.attr("y2", "100%");
gradient.append("stop")
.attr("offset", "0%")
.attr("stop-color", "#ff6b6b");
gradient.append("stop")
.attr("offset", "100%")
.attr("stop-color", "#fc8d59");
// Add bars with animation
svg.selectAll("rect")
.data(bins)
.enter()
.append("rect")
.attr("x", d => x(d.x0) + 1)
.attr("width", d => Math.max(0, x(d.x1) - x(d.x0) - 2))
.attr("y", height)
.attr("height", 0)
.attr("fill", "url(#bar-gradient)")
.attr("rx", 4)
.on("mouseover", function(event, d) {
d3.select(this)
.transition()
.duration(200)
.attr("opacity", 0.7);
})
.on("mouseout", function(event, d) {
d3.select(this)
.transition()
.duration(200)
.attr("opacity", 1);
})
.transition()
.duration(800)
.delay((d, i) => i * 30)
.attr("y", d => y(d.length))
.attr("height", d => height - y(d.length));
// Add x axis
svg.append("g")
.attr("transform", `translate(0,${height})`)
.call(d3.axisBottom(x))
.style("font-size", "12px")
.selectAll("text")
.style("font-family", "system-ui, -apple-system, sans-serif");
svg.append("text")
.attr("x", width / 2)
.attr("y", height + 40)
.style("text-anchor", "middle")
.style("font-size", "14px")
.style("font-family", "system-ui, -apple-system, sans-serif")
.text("Poverty Rate (%)");
// Add y axis
svg.append("g")
.call(d3.axisLeft(y))
.style("font-size", "12px")
.selectAll("text")
.style("font-family", "system-ui, -apple-system, sans-serif");
svg.append("text")
.attr("transform", "rotate(-90)")
.attr("x", -height / 2)
.attr("y", -35)
.style("text-anchor", "middle")
.style("font-size", "14px")
.style("font-family", "system-ui, -apple-system, sans-serif")
.text("Count");
</script>
'))
#| echo: false
#| message: false
#| warning: false
#| title: "Poverty Rate Distribution"
library(htmltools)
library(jsonlite)
# Prepare data for D3
hist_data <- cu_data$Poverty.Rate[!is.na(cu_data$Poverty.Rate)]
HTML(paste0('
<div id="histogram" style="width: 100%; height: 100%;"></div>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
const data = ', toJSON(hist_data), ';
const margin = {top: 20, right: 30, bottom: 50, left: 50};
const width = document.getElementById("histogram").clientWidth - margin.left - margin.right;
const height = document.getElementById("histogram").clientHeight - margin.top - margin.bottom;
const svg = d3.select("#histogram")
.append("svg")
.attr("width", width + margin.left + margin.right)
.attr("height", height + margin.top + margin.bottom)
.append("g")
.attr("transform", `translate(${margin.left},${margin.top})`);
const x = d3.scaleLinear()
.domain([0, d3.max(data)])
.range([0, width]);
const histogram = d3.histogram()
.domain(x.domain())
.thresholds(x.ticks(15));
const bins = histogram(data);
const y = d3.scaleLinear()
.domain([0, d3.max(bins, d => d.length)])
.range([height, 0]);
// Add gradient
const gradient = svg.append("defs")
.append("linearGradient")
.attr("id", "bar-gradient")
.attr("x1", "0%")
.attr("y1", "0%")
.attr("x2", "0%")
.attr("y2", "100%");
gradient.append("stop")
.attr("offset", "0%")
.attr("stop-color", "#ff6b6b");
gradient.append("stop")
.attr("offset", "100%")
.attr("stop-color", "#fc8d59");
// Add bars with animation
svg.selectAll("rect")
.data(bins)
.enter()
.append("rect")
.attr("x", d => x(d.x0) + 1)
.attr("width", d => Math.max(0, x(d.x1) - x(d.x0) - 2))
.attr("y", height)
.attr("height", 0)
.attr("fill", "url(#bar-gradient)")
.attr("rx", 4)
.on("mouseover", function(event, d) {
d3.select(this)
.transition()
.duration(200)
.attr("opacity", 0.7);
})
.on("mouseout", function(event, d) {
d3.select(this)
.transition()
.duration(200)
.attr("opacity", 1);
})
.transition()
.duration(800)
.delay((d, i) => i * 30)
.attr("y", d => y(d.length))
.attr("height", d => height - y(d.length));
// Add x axis
svg.append("g")
.attr("transform", `translate(0,${height})`)
.call(d3.axisBottom(x))
.style("font-size", "12px")
.selectAll("text")
.style("font-family", "system-ui, -apple-system, sans-serif");
svg.append("text")
.attr("x", width / 2)
.attr("y", height + 40)
.style("text-anchor", "middle")
.style("font-size", "14px")
.style("font-family", "system-ui, -apple-system, sans-serif")
.text("Poverty Rate (%)");
// Add y axis
svg.append("g")
.call(d3.axisLeft(y))
.style("font-size", "12px")
.selectAll("text")
.style("font-family", "system-ui, -apple-system, sans-serif");
svg.append("text")
.attr("transform", "rotate(-90)")
.attr("x", -height / 2)
.attr("y", -35)
.style("text-anchor", "middle")
.style("font-size", "14px")
.style("font-family", "system-ui, -apple-system, sans-serif")
.text("Count");
</script>
'))
plot_ly(
x = ~cu_data$Poverty.Rate,
type = "histogram",
nbinsx = 15,
marker = list(
color = "#fc8d59",
line = list(color = "white", width = 2)
)
) %>%
layout(
xaxis = list(
title = list(text = "Poverty Rate (%)", font = list(size = 14)),
gridcolor = "#f0f0f0"
),
yaxis = list(
title = list(text = "Number of Census Tracts", font = list(size = 14)),
gridcolor = "#f0f0f0"
),
plot_bgcolor = "#fafafa",
paper_bgcolor = "white",
showlegend = FALSE
) %>%
config(displayModeBar = FALSE)
# Install tidycensus if you don't have it
# install.packages("tidycensus")
library(tidycensus)
library(dplyr)
# Set your Census API key
census_api_key("8a4517f7bed332fc21d9b4f2173029e771da2eb2", install = TRUE)
# Median household income
income_data <- get_acs(
geography = "tract",
variables = "B19013_001",
state = "IL",
county = "Champaign",
year = 2023,
survey = "acs5"
) %>%
select(GEOID, NAME, median_income = estimate)
# Health insurance coverage (% with coverage)
insurance_data <- get_acs(
geography = "tract",
variables = "S2701_C03_001",  # Percent insured
state = "IL",
county = "Champaign",
year = 2023,
survey = "acs5"
) %>%
select(GEOID, insurance_coverage = estimate)
# Combine them
sdoh_data <- income_data %>%
left_join(insurance_data, by = "GEOID")
# View the data
head(sdoh_data)
# Save to CSV
write.csv(sdoh_data, "/Users/jakecox/rstudio/cu-geo/cu-sdoh.csv", row.names = FALSE)
# Install tidycensus if you don't have it
# install.packages("tidycensus")
library(tidycensus)
library(dplyr)
library(stringr)
# Set your Census API key
census_api_key("8a4517f7bed332fc21d9b4f2173029e771da2eb2", install = TRUE)
# Median household income
income_data <- get_acs(
geography = "tract",
variables = "B19013_001",
state = "IL",
county = "Champaign",
year = 2023,
survey = "acs5"
) %>%
select(GEOID, NAME, median_income = estimate)
# Health insurance coverage (% with coverage)
insurance_data <- get_acs(
geography = "tract",
variables = "S2701_C03_001",  # Percent insured
state = "IL",
county = "Champaign",
year = 2023,
survey = "acs5"
) %>%
select(GEOID, insurance_coverage = estimate)
# Combine them
sdoh_data <- income_data %>%
left_join(insurance_data, by = "GEOID") %>%
mutate(NAMELSAD = str_remove(NAME, "; Champaign County, Illinois")) %>%
select(GEOID, NAMELSAD, median_income, insurance_coverage)
# View the data
head(sdoh_data)
# Save to CSV
write.csv(sdoh_data, "/Users/jakecox/rstudio/cu-geo/cu-sdoh.csv", row.names = FALSE)
sdoh_data <- income_data %>%
left_join(insurance_data, by = "GEOID") %>%
mutate(NAMELSAD = str_remove(NAME, "; Champaign County, Illinois")) %>%
select(GEOID, NAMELSAD, median_income, insurance_coverage)
head(sdoh_data)
# Install tidycensus if you don't have it
# install.packages("tidycensus")
library(tidycensus)
library(dplyr)
library(stringr)
# Set your Census API key
census_api_key("8a4517f7bed332fc21d9b4f2173029e771da2eb2", install = TRUE)
# Median household income
income_data <- get_acs(
geography = "tract",
variables = "B19013_001",
state = "IL",
county = "Champaign",
year = 2023,
survey = "acs5"
) %>%
select(GEOID, NAME, median_income = estimate)
# Check what the NAME column looks like
print("Sample NAME values:")
print(head(income_data$NAME))
# Health insurance coverage (% with coverage)
insurance_data <- get_acs(
geography = "tract",
variables = "S2701_C03_001",  # Percent insured
state = "IL",
county = "Champaign",
year = 2023,
survey = "acs5"
) %>%
select(GEOID, insurance_coverage = estimate)
# Combine them
sdoh_data <- income_data %>%
left_join(insurance_data, by = "GEOID") %>%
mutate(NAMELSAD = str_replace(NAME, ", Champaign County, Illinois", "")) %>%
select(GEOID, NAMELSAD, median_income, insurance_coverage)
# View the data
head(sdoh_data)
# Save to CSV
write.csv(sdoh_data, "/Users/jakecox/rstudio/cu-geo/cu-sdoh.csv", row.names = FALSE)
dian household income
# Median household income
income_data <- get_acs(
geography = "tract",
variables = "B19013_001",
state = "IL",
county = "Champaign",
year = 2023,
survey = "acs5"
) %>%
select(GEOID, NAME, median_income = estimate)
# Health insurance coverage (% with coverage)
insurance_data <- get_acs(
geography = "tract",
variables = "S2701_C03_001",
state = "IL",
county = "Champaign",
year = 2023,
survey = "acs5"
) %>%
select(GEOID, insurance_coverage = estimate)
# Combine them
sdoh_data <- income_data %>%
left_join(insurance_data, by = "GEOID") %>%
mutate(NAMELSAD = str_remove(NAME, "; Champaign County; Illinois")) %>%
select(GEOID, NAMELSAD, median_income, insurance_coverage)
# View the data
head(sdoh_data)
# Save to CSV
write.csv(sdoh_data, "/Users/jakecox/rstudio/cu-geo/cu-sdoh.csv", row.names = FALSE)
library(sf)
library(dplyr)
cu_geo <- st_read("/Users/jakecox/rstudio/cu-geo/cu_clipped.json", quiet = TRUE)
cu_mortality <- read.csv("/Users/jakecox/rstudio/cu-geo/cu-mortality-clean.csv")
cu_data <- cu_geo %>%
left_join(cu_mortality, by = "NAMELSAD")
print(paste("GeoJSON tracts:", nrow(cu_geo)))
print(paste("Mortality data tracts:", nrow(cu_mortality)))
print(paste("Joined data tracts:", nrow(cu_data)))
print(paste("Tracts with mortality data:", sum(!is.na(cu_data$Life_Expectancy_2010_2015))))
head(cu_data)
st_write(cu_data, "/Users/jakecox/rstudio/cu-geo/cu_with_mortality.json",
delete_dsn = TRUE)
# Read the GeoJSON file
cu_geo <- st_read("/Users/jakecox/rstudio/cu-geo/cu_clipped.json", quiet = TRUE)
# Read the mortality CSV file
cu_mortality <- read.csv("/Users/jakecox/rstudio/cu-geo/cu-mortality-clean.csv")
# Join the data by NAMELSAD
cu_data <- cu_geo %>%
left_join(cu_mortality, by = "NAMELSAD")
# Check the join
print(paste("GeoJSON tracts:", nrow(cu_geo)))
print(paste("Mortality data tracts:", nrow(cu_mortality)))
print(paste("Joined data tracts:", nrow(cu_data)))
print(paste("Tracts with mortality data:", sum(!is.na(cu_data$Life_Expectancy_2010_2015))))
head(cu_data)
st_write(cu_data, "/Users/jakecox/rstudio/cu-geo/cu_with_mortality.json",
driver = "GeoJSON",
delete_dsn = TRUE)
# Create leaflet map
leaflet(cu_data) %>%
addProviderTiles(providers$CartoDB.Positron) %>%
addPolygons(
fillColor = ~pal_life_exp(Life_Expectancy_2010_2015),
weight = 1,
opacity = 1,
color = "white",
fillOpacity = 0.7,
highlightOptions = highlightOptions(
weight = 2,
color = "#666",
fillOpacity = 0.9,
bringToFront = TRUE
),
label = ~paste0(
"Tract: ", NAMELSAD, "<br>",
"Life Expectancy: ", round(Life_Expectancy_2010_2015, 1), " years<br>",
"Population: ", format(Population, big.mark = ",")
) %>% lapply(HTML)
) %>%
addLegend(
position = "bottomright",
pal = pal_life_exp,
values = ~Life_Expectancy_2010_2015,
title = "Life Expectancy<br>(years, 2010-2015)",
opacity = 0.7,
na.label = "No data"
)
library(sf)
library(leaflet)
library(htmltools)
# Read the joined GeoJSON file
cu_data <- st_read("/Users/jakecox/rstudio/cu-geo/cu_with_mortality.json", quiet = TRUE)
# Create color palette for life expectancy
pal_life_exp <- colorNumeric(
palette = "RdYlGn",  # Red-Yellow-Green (red=low, green=high)
domain = cu_data$Life_Expectancy_2010_2015[!is.na(cu_data$Life_Expectancy_2010_2015)],
na.color = "grey"
)
# Create leaflet map
leaflet(cu_data) %>%
addProviderTiles(providers$CartoDB.Positron) %>%
addPolygons(
fillColor = ~pal_life_exp(Life_Expectancy_2010_2015),
weight = 1,
opacity = 1,
color = "white",
fillOpacity = 0.7,
highlightOptions = highlightOptions(
weight = 2,
color = "#666",
fillOpacity = 0.9,
bringToFront = TRUE
),
label = ~paste0(
"Tract: ", NAMELSAD, "<br>",
"Life Expectancy: ", round(Life_Expectancy_2010_2015, 1), " years<br>",
"Population: ", format(Population, big.mark = ",")
) %>% lapply(HTML)
) %>%
addLegend(
position = "bottomright",
pal = pal_life_exp,
values = ~Life_Expectancy_2010_2015,
title = "Life Expectancy<br>(years, 2010-2015)",
opacity = 0.7,
na.label = "No data"
)
