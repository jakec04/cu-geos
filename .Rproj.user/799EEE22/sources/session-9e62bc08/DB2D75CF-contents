---
title: "Chambana Health Dashboard"
format: 
  dashboard:
    theme: flatly
    orientation: rows
editor_options: 
  chunk_output_type: console
---

# Social Determinants of Health

## Row {height="60%"}

### Column
```{r}
#| echo: false
#| message: false
#| warning: false
#| title: "Poverty Rate by Census Tract"

# Load packages
library(sf)
library(leaflet)
library(dplyr)
library(plotly)

# Read the fixed GeoJSON file
cu_geo <- st_read("/Users/jakecox/rstudio/cu-geo/cu-tracts-fixed.json", quiet = TRUE)

# Read the poverty CSV file
cu_poverty <- read.csv("/Users/jakecox/rstudio/cu-geo/cu-poverty_revised.csv")

# Read the SDOH CSV file
cu_sdoh <- read.csv("/Users/jakecox/rstudio/cu-geo/cu-sdoh.csv")

# Join the data by NAMELSAD
cu_data <- cu_geo %>%
  left_join(cu_poverty, by = "NAMELSAD") %>%
  left_join(cu_sdoh, by = "NAMELSAD")

# Create color palette for poverty rate
pal_poverty <- colorNumeric(
  palette = "YlOrRd",
  domain = cu_data$Poverty.Rate[!is.na(cu_data$Poverty.Rate)],
  na.color = "grey"
)

# Create leaflet map
leaflet(cu_data) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(
    fillColor = ~pal_poverty(Poverty.Rate),
    weight = 1,
    opacity = 1,
    color = "white",
    fillOpacity = 0.7,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "#666",
      fillOpacity = 0.9
    ),
    label = ~paste0("Tract: ", NAMELSAD, "<br>Poverty Rate: ", 
                    round(Poverty.Rate, 1), "%") %>% 
      lapply(htmltools::HTML)
  ) %>%
  addLegend(
    position = "bottomright",
    pal = pal_poverty,
    values = ~Poverty.Rate,
    title = "Poverty Rate (%)",
    opacity = 0.7,
    na.label = "No data"
  )
```

### Column
```{r}
#| echo: false
#| message: false
#| warning: false
#| title: "Median Household Income"

# Create color palette for median income
pal_income <- colorNumeric(
  palette = "Greens",
  domain = cu_data$median_income[!is.na(cu_data$median_income)],
  na.color = "grey"
)

# Create leaflet map
leaflet(cu_data) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(
    fillColor = ~pal_income(median_income),
    weight = 1,
    opacity = 1,
    color = "white",
    fillOpacity = 0.7,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "#666",
      fillOpacity = 0.9
    ),
    label = ~paste0("Tract: ", NAMELSAD, "<br>Median Income: $", 
                    format(median_income, big.mark = ",")) %>% 
      lapply(htmltools::HTML)
  ) %>%
  addLegend(
    position = "bottomright",
    pal = pal_income,
    values = ~median_income,
    title = "Median Income ($)",
    opacity = 0.7,
    na.label = "No data",
    labFormat = labelFormat(prefix = "$", big.mark = ",")
  )
```

### Column
```{r}
#| echo: false
#| message: false
#| warning: false
#| title: "Health Insurance Coverage"

# Create color palette for insurance coverage
pal_insurance <- colorNumeric(
  palette = "Blues",
  domain = cu_data$insurance_coverage[!is.na(cu_data$insurance_coverage)],
  na.color = "grey"
)

# Create leaflet map
leaflet(cu_data) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(
    fillColor = ~pal_insurance(insurance_coverage),
    weight = 1,
    opacity = 1,
    color = "white",
    fillOpacity = 0.7,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "#666",
      fillOpacity = 0.9
    ),
    label = ~paste0("Tract: ", NAMELSAD, "<br>Insurance Coverage: ", 
                    round(insurance_coverage, 1), "%") %>% 
      lapply(htmltools::HTML)
  ) %>%
  addLegend(
    position = "bottomright",
    pal = pal_insurance,
    values = ~insurance_coverage,
    title = "Insurance Coverage (%)",
    opacity = 0.7,
    na.label = "No data"
  )
```

## Row {height="40%"}

### Column
```{r}
#| echo: false
#| message: false
#| warning: false
#| title: "Poverty Rate Distribution"

plot_ly(
  x = ~cu_data$Poverty.Rate,
  type = "histogram",
  nbinsx = 15,
  marker = list(
    color = "#fc8d59",
    line = list(color = "white", width = 2)
  )
) %>%
  layout(
    xaxis = list(
      title = list(text = "Poverty Rate (%)", font = list(size = 14)),
      gridcolor = "#f0f0f0"
    ),
    yaxis = list(
      title = list(text = "Number of Census Tracts", font = list(size = 14)),
      gridcolor = "#f0f0f0"
    ),
    plot_bgcolor = "#fafafa",
    paper_bgcolor = "white",
    showlegend = FALSE
  ) %>%
  config(displayModeBar = FALSE)
```

### Column
```{r}
#| echo: false
#| message: false
#| warning: false
#| title: "Income Distribution"

plot_ly(
  x = ~cu_data$median_income,
  type = "histogram",
  nbinsx = 15,
  marker = list(
    color = "#31a354",
    line = list(color = "white", width = 2)
  )
) %>%
  layout(
    xaxis = list(
      title = list(text = "Median Household Income ($)", font = list(size = 14)),
      gridcolor = "#f0f0f0"
    ),
    yaxis = list(
      title = list(text = "Number of Census Tracts", font = list(size = 14)),
      gridcolor = "#f0f0f0"
    ),
    plot_bgcolor = "#fafafa",
    paper_bgcolor = "white",
    showlegend = FALSE
  ) %>%
  config(displayModeBar = FALSE)
```

### Column
```{r}
#| echo: false
#| message: false
#| warning: false
#| title: "Insurance Coverage Distribution"

plot_ly(
  x = ~cu_data$insurance_coverage,
  type = "histogram",
  nbinsx = 15,
  marker = list(
    color = "#3182bd",
    line = list(color = "white", width = 2)
  )
) %>%
  layout(
    xaxis = list(
      title = list(text = "Health Insurance Coverage (%)", font = list(size = 14)),
      gridcolor = "#f0f0f0"
    ),
    yaxis = list(
      title = list(text = "Number of Census Tracts", font = list(size = 14)),
      gridcolor = "#f0f0f0"
    ),
    plot_bgcolor = "#fafafa",
    paper_bgcolor = "white",
    showlegend = FALSE
  ) %>%
  config(displayModeBar = FALSE)
```
